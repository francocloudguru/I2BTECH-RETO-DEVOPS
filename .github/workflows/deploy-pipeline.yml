name: Deploy I2BTECH Reto DevOps

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: self-hosted

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Login to Docker registry
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_TOKEN }}

    - name: Build and push image
      run: |
        docker build -t ${{ secrets.IMAGE_REPOSITORY }}:${{ secrets.IMAGE_TAG }} .
        docker push ${{ secrets.IMAGE_REPOSITORY }}:${{ secrets.IMAGE_TAG }}

    - name: Copy repo to EC2
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        source: "."
        target: "~/I2BTECH-RETO-DEVOPS"

    - name: Prepare EC2 (Ansible + K8s secrets)
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          cd ~/I2BTECH-RETO-DEVOPS

          # Ejecutar Ansible para instalar Docker, Minikube, Terraform
          cd ansible
          ansible-playbook -i "localhost," -c local playbook.yml
          cd ..

          kubectl create ns i2btech-reto-app-ns --dry-run=client -o yaml | kubectl apply -f -

          kubectl create secret generic i2btech-reto-app-basic-auth \
            --from-literal=.htpasswd="${{ secrets.HTPASSWD_CONTENT }}" \
            -n i2btech-reto-app-ns \
            --dry-run=client -o yaml | kubectl apply -f -

          kubectl create secret tls i2btech-reto-app-tls \
            --cert=<(echo "${{ secrets.TLS_CERT }}") \
            --key=<(echo "${{ secrets.TLS_KEY }}") \
            -n i2btech-reto-app-ns \
            --dry-run=client -o yaml | kubectl apply -f -

    - name: Terraform apply (deploy Helm chart)
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          cd ~/I2BTECH-RETO-DEVOPS/terraform
          terraform init
          terraform apply -auto-approve \
            -var "image_repository=${{ secrets.IMAGE_REPOSITORY }}" \
            -var "image_tag=${{ secrets.IMAGE_TAG }}"

    - name: Validate endpoints
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          # Obtenemos la IP del LoadBalancer (puede requerir minikube tunnel en local)
          echo "Esperando IP externa de i2btech-reto-app..."
          kubectl get svc i2btech-reto-app -w &
          sleep 30
          EXTERNAL_IP=$(kubectl get svc i2btech-reto-app -o jsonpath='{.status.loadBalancer.ingress[0].ip}')

          echo "Testing https://$EXTERNAL_IP/"
          curl -k https://$EXTERNAL_IP/ || exit 1

          echo "Testing https://$EXTERNAL_IP/private"
          # Ajusta user:password segÃºn el contenido de tu HTPASSWD_CONTENT
          curl -k https://$EXTERNAL_IP/private --user user:password || exit 1

          echo "All endpoints OK"
